# Tailscale Split DNS Server
# Provides DNS resolution for *.erodev.cloud domains over Tailscale
# Returns Tailscale IP (100.116.229.118) instead of public IP

services:
  coredns:
    image: coredns/coredns:latest
    container_name: tailscale-dns
    restart: unless-stopped

    # Use our custom Corefile configuration
    command: ["-conf", "/etc/coredns/Corefile"]

    # Bind to Tailscale IP for production use
    ports:
      - "100.116.229.118:53:53/tcp"
      - "100.116.229.118:53:53/udp"

    volumes:
      - ./Corefile:/etc/coredns/Corefile:ro

    # Health check - Use dig to test DNS resolution
    healthcheck:
      test: ["CMD", "/coredns", "-version"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Network configuration
    networks:
      - tailscale-dns

networks:
  tailscale-dns:
    name: tailscale-dns
    driver: bridge
